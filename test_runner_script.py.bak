#!/usr/bin/env python
"""
Script seguro para ejecutar pruebas con opciones recomendadas.
Este script siempre usa --keepdb para evitar recrear la base de datos.
"""

import os
import sys
import subprocess
import argparse

def print_warning():
    print("\033[91m")  # Rojo
    print("=" * 80)
    print("                            ¡¡¡ ADVERTENCIA !!!")
    print("=" * 80)
    print("Este script ejecutará pruebas contra una base de datos de prueba separada.")
    print("NUNCA ejecute pruebas contra una base de datos de producción.")
    print("Siempre usamos --keepdb para evitar recrear la base de datos.")
    print("=" * 80)
    print("\033[0m")  # Reset color

def run_tests(test_path=None, verbosity=1):
    """Ejecutar pruebas con las opciones seguras."""
    cmd = ['python', 'manage.py', 'test']
    
    if test_path:
        cmd.append(test_path)
    
    # Añadir siempre estas opciones
    cmd.extend(['--keepdb', f'--verbosity={verbosity}'])
    
    print(f"\nEjecutando: {' '.join(cmd)}\n")
    
    try:
        result = subprocess.run(cmd)
        return result.returncode
    except KeyboardInterrupt:
        print("\n\nPruebas interrumpidas por el usuario.")
        return 1

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='Ejecutar pruebas Django de forma segura')
    parser.add_argument('test_path', nargs='?', help='Ruta específica a pruebas (ej: apps.authentication.tests)')
    parser.add_argument('-v', '--verbosity', type=int, choices=[0, 1, 2, 3], default=1, 
                        help='Nivel de detalle (0=mínimo, 3=máximo)')
    
    args = parser.parse_args()
    
    print_warning()
    
    # Confirmar ejecución
    confirm = input("¿Está seguro de ejecutar las pruebas? (s/N): ")
    if confirm.lower() != 's':
        print("Operación cancelada.")
        sys.exit(0)
        
    sys.exit(run_tests(args.test_path, args.verbosity))
